<div class="diag-wrapper">
  <h3>Tipo de diagn√≥stico (los campos de esta secci√≥n no pueden estar vac√≠os)</h3>
  <div class="tipo-grid">
    <label><input type="radio" [(ngModel)]="tipoDiagnostico" [value]="1" name="tipoDiagnostico" /> Impresi√≥n diagn√≥stica</label>
    <label><input type="radio" [(ngModel)]="tipoDiagnostico" [value]="2" name="tipoDiagnostico" /> Confirmado nuevo</label>
    <label><input type="radio" [(ngModel)]="tipoDiagnostico" [value]="3" name="tipoDiagnostico" /> Confirmado repetido</label>
  </div>

  <!-- ======================== DIAGN√ìSTICOS ======================== -->
  <h4>Diagn√≥sticos</h4>

  <table class="ui-table">
    <thead>
      <tr>
        <th style="width: 38%">Diagn√≥stico</th>
        <th style="width: 22%">C√≥digo-Descripci√≥n</th>
        <th style="width: 30%">Descripci√≥n</th>
        <th style="width: 10%; text-align:center">Acciones</th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let d of diagnosticos; let i = index">
        <td>
          <div class="autocomplete">
            <input
              #inp
              class="input"
              type="text"
              placeholder="Escriba c√≥digo o palabra clave"
              [value]="diagControls[i].value || ''"
              (focus)="openDiagMenu(i)"
              (input)="onDiagInput(i, inp.value)"
            />
        
            <div class="dropdown" *ngIf="diagMenuOpen[i] && diagFiltrados[i]?.length">
              <div class="option"
                   *ngFor="let op of diagFiltrados[i]"
                   (mousedown)="onSelectDiagnostico(i, op)">
                <strong>{{ op.codigo }}</strong> ‚Äî {{ op.descripcion }}
              </div>
            </div>
        
            <div class="dropdown" *ngIf="diagMenuOpen[i] && !diagFiltrados[i]?.length">
              <div class="nores">Sin resultados</div>
            </div>
          </div>
        </td>
        

        <td>
          <input class="input" type="text" [value]="d.codigo || ''" readonly />
        </td>

        <td>
          <input class="input" type="text" [value]="d.descripcion || ''" readonly />
        </td>

        <td class="center">
          <button type="button" class="btn danger" (click)="removeDiagnostico(i)">üóëÔ∏è</button>
        </td>
      </tr>
    </tbody>
  </table>

  <div class="actions-row">
    <button type="button" class="btn" (click)="addDiagnostico()">+ Agregar diagn√≥stico</button>
  </div>

  <!-- ======================== MEDICAMENTOS ======================== -->
  <h4>Medicamentos</h4>

  <table class="ui-table">
    <thead>
      <tr>
        <th style="width: 26%">Medicamento</th>
        <th style="width: 16%">V√≠a administraci√≥n</th>
        <th style="width: 10%">Cantidad</th>
        <th style="width: 38%">Posolog√≠a y duraci√≥n</th>
        <th style="width: 10%; text-align:center">Acciones</th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let m of medicamentos; let i = index">
        <td>
          <input class="input" type="text" placeholder="Nombre del medicamento" [(ngModel)]="m.nombreMedicamentoManual" name="med_nombre_{{i}}" />
        </td>

        <td>
          <select class="input" [(ngModel)]="m.via" name="med_via_{{i}}">
            <option value="">Seleccione v√≠a</option>
            <option>Oral</option>
            <option>Intravenosa</option>
            <option>Intramuscular</option>
            <option>Subcut√°nea</option>
            <option>T√≥pica</option>
          </select>
        </td>

        <td>
          <input class="input" type="number" min="0" step="1" placeholder="Cant." [(ngModel)]="m.dosisCantidad" name="med_cant_{{i}}" />
        </td>

        <td>
          <input class="input" type="text"
                 placeholder="Posolog√≠a y duraci√≥n"
                 [(ngModel)]="m.dosificacion"
                 name="med_poso_{{i}}" />
        </td>
        

        <td class="center">
          <button type="button" class="btn danger" (click)="removeMedicamento(i)">üóëÔ∏è</button>
        </td>
      </tr>
    </tbody>
  </table>

  <div class="actions-row">
    <button type="button" class="btn" (click)="addMedicamento()">+ Agregar medicamento</button>
  </div>

  <!-- ======================== PLAN ======================== -->
  <div class="mt-2">
    <label class="lbl">Recomendaciones, plan de tratamiento</label>
    <textarea class="input plan-textarea"
          rows="4"
          [(ngModel)]="plan"
          placeholder="Indique el plan de tratamiento"></textarea>
  </div>

  <div class="footer-actions">
    <button type="button" class="btn success" (click)="guardarTodo()">Registrar</button>
  </div>
</div>
